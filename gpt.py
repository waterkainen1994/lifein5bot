import os
from openai import AsyncOpenAI

client = AsyncOpenAI(api_key=os.getenv("OPENAI_API_KEY"))

async def generate_prediction(user_input, future_mode=False, previous_response=None):
    prompt = user_input
    if future_mode and previous_response:
        prompt += (
            f"\n\n–ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞:\n{previous_response}\n"
            "–¢–µ–ø–µ—Ä—å –ø–æ–∫–∞–∂–∏ —Ç—Ä–∏ —Å–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–µ–Ω—è –∂–¥—É—Ç, –µ—Å–ª–∏ —è –Ω–µ –≤—ã–π–¥—É –∏–∑ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è, "
            "—Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞, –∫–∞–∫–∏–µ —É –Ω–∏—Ö –±—É–¥—É—Ç –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è, –∏ –∫–∞–∫ –æ–Ω–∏ –æ—Ç—Ä–∞–∑—è—Ç—Å—è –Ω–∞ –º–Ω–µ –∏ –º–æ–µ–º –∑–¥–æ—Ä–æ–≤—å–µ? "
            "–ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º, —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏ –æ–ø–∏—Å—ã–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏. "
        )
    else:
        prompt += (
            "\n\n–ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–π –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–µ–π –∂–∏–∑–Ω–∏ —á–µ—Ä–µ–∑ 5 –ª–µ—Ç. "
            "–£—á—Ç–∏ —Å–ª–µ–¥—É—é—â–∏–µ –∞—Å–ø–µ–∫—Ç—ã: –∫–∞—Ä—å–µ—Ä–∞, –∑–¥–æ—Ä–æ–≤—å–µ, —Å–µ–º–µ–π–Ω–∞—è –∂–∏–∑–Ω—å, —Ö–æ–±–±–∏, —Ñ–∏–Ω–∞–Ω—Å—ã, —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏. "
            "–û–ø–∏—à–∏, –∫–∞–∫ —ç–∫–æ–Ω–æ–º–∏–∫–∞ –∏ –ø–æ–ª–∏—Ç–∏–∫–∞ –º–æ–µ–π —Å—Ç—Ä–∞–Ω—ã –ø–æ–≤–ª–∏—è—é—Ç –Ω–∞ –º–æ—é –∂–∏–∑–Ω—å. "
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç –≤ –≤–∏–¥–µ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Å 3-5 –ø—É–Ω–∫—Ç–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º–∞—Ç '1.', '2.', '3.' –∏ —Ç.–¥. "
            "(–Ω–∞–ø—Ä–∏–º–µ—Ä: '1. –¢–µ–∫—Å—Ç', '2. –¢–µ–∫—Å—Ç', '3. –¢–µ–∫—Å—Ç'). –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∑–≤—ë–∑–¥–æ—á–∫–∏ (*). "
            "–ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º, —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏ –æ–ø–∏—Å—ã–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏. "
            "–°–¥–µ–ª–∞–π –æ–ø–∏—Å–∞–Ω–∏–µ –∂–∏–≤—ã–º, —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –¥–µ—Ç–∞–ª—è–º–∏, —á—Ç–æ–±—ã –æ–Ω–æ –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ —Ä–µ–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –º–æ–µ–π –±—É–¥—É—â–µ–π –∂–∏–∑–Ω–∏."
            "üï∞ –¢–≤–æ—è –∂–∏–∑–Ω—å —á–µ—Ä–µ–∑ 5 –ª–µ—Ç (—Ç–µ–±–µ [–≤–æ–∑—Ä–∞—Å—Ç] –ª–µ—Ç):, üìç –û–±—â–∏–π —Ñ–æ–Ω, üëî –†–∞–±–æ—Ç–∞, üß† –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, "
            "üè° –õ–∏—á–Ω–∞—è –∂–∏–∑–Ω—å, ü©∫ –ó–¥–æ—Ä–æ–≤—å–µ, üé£ –ò–Ω—Ç–µ—Ä–µ—Å—ã, üìå –ó–∞–∫–ª—é—á–µ–Ω–∏–µ:, üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –≤–µ–∫—Ç–æ—Ä—ã –ø–æ–≤–æ—Ä–æ—Ç–∞:. "
            "–ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π."       
        )
    
    response = await client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {
                "role": "system",
                "content": (
                    "–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –æ–ø—ã—Ç–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥ —Å 30-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞—Ç—å –±—É–¥—É—â–µ–µ —á–µ–ª–æ–≤–µ–∫–∞. "
                    "–£—á–∏—Ç—ã–≤–∞–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —á–µ–ª–æ–≤–µ–∫–∞, —É—Å–ª–æ–≤–∏—è —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω –∂–∏–≤–µ—Ç, –µ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç "
                    "–∏ –æ–±—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –µ–≥–æ –∂–∏–∑–Ω–∏. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ–±–æ –º–Ω–µ –∏ —Å–æ–∑–¥–∞–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–µ–π –∂–∏–∑–Ω–∏."
                )
            },
            {"role": "user", "content": prompt}
        ],
        max_tokens=1000,  # –û—Å—Ç–∞–≤–ª—è–µ–º 1500 –¥–ª—è –±–æ–ª—å—à–µ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
        temperature=0.7,
    )
    
    return response.choices[0].message.content
